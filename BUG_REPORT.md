# SDB ML Dashboard Bug Report

**Reviewed by:** Spencer  
**Date:** 2026-02-02

---

## Critical Bugs Fixed

### BUG-001: Wrong Directory Paths ✅ FIXED
**Location:** `backend/config.json` and `backend/main.py` (lines 41-46)  
**Issue:** Paths point to `/Users/miguelitodeguzman/Projects/SDB` but actual location is `/Users/miguelitodeguzman/Projects/AI-projects/SDB`  
**Impact:** All file operations fail, tests fail with `FileNotFoundError`  
**Fix Applied:** Updated both `config.json` and `DEFAULT_SETTINGS` in `main.py`

### BUG-002: Test Import Errors ✅ FIXED
**Location:** `backend/tests/test_layer_profiler.py`  
**Issue:** Uses `from backend.profiling...` but should use relative imports with sys.path fix  
**Impact:** Test collection fails  
**Fix Applied:** Added sys.path.insert and changed imports

---

## Existing Bugs (Tagged in Code)

The codebase already tracks these with inline comments:

| Bug ID | Description | Status |
|--------|-------------|--------|
| BUG-032 | KV cache size calculation after generation | Implemented |
| BUG-033 | Model features extraction for database | Implemented |
| BUG-040 | Session model features storage | Implemented |
| BUG-043 | System settling after model loading (3s wait) | Implemented |
| BUG-044 | EOS token handling for accurate metrics | Implemented |
| BUG-048 | Warmup inference to eliminate JIT costs | Implemented |

---

## Remaining Test Failures (After Path Fix)

Run `python3 -m pytest tests/ -v` to verify. Expected remaining failures:

1. **TestModelEndpoints::test_get_models** - May need model files present
2. **TestProfilingEndpoints** - May need database/profiling data
3. **TestAnalyticsEndpoints** - Need profiling data
4. **TestSettingsEndpoints::test_post_settings** - Settings validation

---

## Architecture Review: Prompt Processing vs Energy Profiles

### Current Flow
1. `POST /api/profiling/generate` receives prompt + model path
2. Model loaded, warmup run (optional), baseline measured
3. Tokenization → Prefill → Decode loop
4. Power samples collected via `PowerMonitor`
5. Per-token energy calculated: `energy_mj = power_mw * duration_ms / 1000`

### Energy Predictor Module (`profiling/energy_predictor.py`)
- Implements ML model to predict energy BEFORE inference
- Uses architectural features + prompt characteristics
- Based on "From Prompts to Power" paper (R²=0.92-0.98)
- **Status:** Model training implemented, needs profiling data to work

### Suggested Improvements

1. **Prompt Feature Extraction**
   - Add prompt complexity metrics (vocabulary diversity, sentence length, etc.)
   - Add semantic features (could use embedding-based metrics)

2. **Energy Profiling Calibration**
   - Current energy calculation assumes linear power × time
   - Consider adding thermal state compensation
   - Add power state detection (idle vs active transitions)

3. **Missing: Prompt → Energy Correlation Analysis**
   - Build a correlation view: which prompt features drive energy?
   - Regression coefficients from EnergyPredictor could power this

---

## Files Modified

1. `backend/config.json` - Fixed paths
2. `backend/main.py` - Fixed DEFAULT_SETTINGS paths
3. `backend/tests/test_layer_profiler.py` - Fixed imports

---

## Next Steps

1. Verify tests pass with path fixes
2. Create missing directories if needed:
   ```bash
   mkdir -p ~/Projects/AI-projects/SDB/output
   mkdir -p ~/Projects/AI-projects/SDB/datasets-from-json
   mkdir -p ~/Projects/AI-projects/SDB/text-datasets
   mkdir -p ~/Projects/AI-projects/SDB/trained-models
   ```
3. Review energy predictor training pipeline
4. Build prompt → energy correlation dashboard component

---

*Report generated by Spencer - IndividuationLab DevOps*
